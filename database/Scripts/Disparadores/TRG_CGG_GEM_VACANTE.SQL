/**
* FUNCION SII.TRG_KG_CGG_GEM_VACANTE. REGISTRA LA BITACORA DE LAS ACTIVIDADES REALIZADAS SOBRE LA INFORMACION ALMACENADA EN LA TABLA SII.CGG_GEM_VACANTE
*/
CREATE OR REPLACE FUNCTION SII.TRG_AUD_CGG_GEM_VACANTE() RETURNS TRIGGER AS
$$
DECLARE
TMP_CUSU_CODIGO VARCHAR;
TMP_IP VARCHAR;
TMP_SESSION_ID VARCHAR;
TMP_DATO_NUEVO VARCHAR;
TMP_DATO_ANTIGUO VARCHAR;
TMP_USUARIO VARCHAR;
TMP_CODIGO VARCHAR;
BEGIN
	TMP_DATO_ANTIGUO = '';
	TMP_DATO_NUEVO = '';
	IF (TG_OP = 'INSERT') THEN
		TMP_USUARIO = NEW.CGVCN_USUARIO_INSERT;
		SELECT CUSU_CODIGO INTO TMP_CUSU_CODIGO FROM SII.CGG_USUARIO WHERE CUSU_NOMBRE_USUARIO = NEW.CGVCN_USUARIO_INSERT;
		SELECT CSSSN_IP, CSSSN_ID INTO TMP_IP, TMP_SESSION_ID FROM SII.CGG_SEC_SESION WHERE CUSU_CODIGO = TMP_CUSU_CODIGO AND CSSSN_ACTIVO = TRUE;
	ELSIF (TG_OP = 'UPDATE') THEN
		TMP_USUARIO = NEW.CGVCN_USUARIO_UPDATE;
		SELECT CUSU_CODIGO INTO TMP_CUSU_CODIGO FROM SII.CGG_USUARIO WHERE CUSU_NOMBRE_USUARIO = NEW.CGVCN_USUARIO_UPDATE;
		SELECT CSSSN_IP, CSSSN_ID INTO TMP_IP, TMP_SESSION_ID FROM SII.CGG_SEC_SESION WHERE CUSU_CODIGO = TMP_CUSU_CODIGO AND CSSSN_ACTIVO = TRUE;
		TMP_DATO_ANTIGUO = '<'||TG_TABLE_NAME||'>'||
			'<CGVCN_CODIGO>'||COALESCE(OLD.CGVCN_CODIGO, '')||'</CGVCN_CODIGO>'||
			'<CUSU_CODIGO>'||COALESCE(OLD.CUSU_CODIGO, '')||'</CUSU_CODIGO>'||
			'<CSCTP_CODIGO>'||COALESCE(OLD.CSCTP_CODIGO, '')||'</CSCTP_CODIGO>'||
			'<CGTCN_CODIGO>'||COALESCE(OLD.CGTCN_CODIGO, '')||'</CGTCN_CODIGO>'||
			'<CGTSA_CODIGO>'||COALESCE(OLD.CGTSA_CODIGO, '')||'</CGTSA_CODIGO>'||
			'<CGCRG_CODIGO>'||COALESCE(OLD.CGCRG_CODIGO, '')||'</CGCRG_CODIGO>'||
			'<CISLA_CODIGO>'||COALESCE(OLD.CISLA_CODIGO, '')||'</CISLA_CODIGO>'||
			'<CGTPR_CODIGO>'||COALESCE(OLD.CGTPR_CODIGO, '')||'</CGTPR_CODIGO>'||
			'<CGVCN_NUMERO>'||COALESCE(OLD.CGVCN_NUMERO, 0)||'</CGVCN_NUMERO>'||
			'<CGVCN_TITULO>'||COALESCE(OLD.CGVCN_TITULO, '')||'</CGVCN_TITULO>'||
			'<CGVCN_DESCRIPCION>'||COALESCE(OLD.CGVCN_DESCRIPCION, '')||'</CGVCN_DESCRIPCION>'||
			'<CGVCN_SALARIO>'||COALESCE(OLD.CGVCN_SALARIO, 0)||'</CGVCN_SALARIO>'||
			'<CGVCN_DIRECCION>'||COALESCE(OLD.CGVCN_DIRECCION, '')||'</CGVCN_DIRECCION>'||
			'<CGVCN_FECHA_INGRESO>'||COALESCE(OLD.CGVCN_FECHA_INGRESO, CURRENT_TIMESTAMP)||'</CGVCN_FECHA_INGRESO>'||
			'<CGVCN_FECHA_PUBLICACION>'||COALESCE(OLD.CGVCN_FECHA_PUBLICACION, CURRENT_TIMESTAMP)||'</CGVCN_FECHA_PUBLICACION>'||
			'<CGVCN_FECHA_EXPIRACION>'||COALESCE(OLD.CGVCN_FECHA_EXPIRACION, CURRENT_TIMESTAMP)||'</CGVCN_FECHA_EXPIRACION>'||
			'<CGVCN_DURACION_OFERTA>'||COALESCE(OLD.CGVCN_DURACION_OFERTA, 0)||'</CGVCN_DURACION_OFERTA>'||
			'<CGVCN_ESTADO_OFERTA>'||COALESCE(OLD.CGVCN_ESTADO_OFERTA, 0)||'</CGVCN_ESTADO_OFERTA>'||
			'<CGVCN_NUMERO_VACANTES>'||COALESCE(OLD.CGVCN_NUMERO_VACANTES, 0)||'</CGVCN_NUMERO_VACANTES>'||
			'<CGVCN_DURACION>'||COALESCE(OLD.CGVCN_DURACION, 0)||'</CGVCN_DURACION>'||
			'<CGVCN_DURACION_TIEMPO>'||COALESCE(OLD.CGVCN_DURACION_TIEMPO, 0)||'</CGVCN_DURACION_TIEMPO>'||
			'<CGVCN_EXPERIENCIA>'||COALESCE(OLD.CGVCN_EXPERIENCIA, '')||'</CGVCN_EXPERIENCIA>'||
			'<CGVCN_NUMERO_COMUNICADO>'||COALESCE(OLD.CGVCN_NUMERO_COMUNICADO, '')||'</CGVCN_NUMERO_COMUNICADO>'||
			'<CGVCN_OFERTA_APROBADA>'||COALESCE(OLD.CGVCN_OFERTA_APROBADA, 0)||'</CGVCN_OFERTA_APROBADA>'||
			'<CGVCN_EXISTENCIA_MANOBRA>'||COALESCE(OLD.CGVCN_EXISTENCIA_MANOBRA, 0)||'</CGVCN_EXISTENCIA_MANOBRA>'||
			'<CGVCN_NUMERO_MANOBRA>'||COALESCE(OLD.CGVCN_NUMERO_MANOBRA, '')||'</CGVCN_NUMERO_MANOBRA>'||
			'<CGVCN_FECHA_MANOBRA>'||COALESCE(OLD.CGVCN_FECHA_MANOBRA, CURRENT_TIMESTAMP)||'</CGVCN_FECHA_MANOBRA>'||
			'<CGVCN_ANIO>'||COALESCE(OLD.CGVCN_ANIO, 0)||'</CGVCN_ANIO>'||
			'<CGVCN_CUBIERTA>'||COALESCE(OLD.CGVCN_CUBIERTA, FALSE)||'</CGVCN_CUBIERTA>'||
			'<CGVCN_JUSTIFICACION_NO_CONTRAT>'||COALESCE(OLD.CGVCN_JUSTIFICACION_NO_CONTRAT, '')||'</CGVCN_JUSTIFICACION_NO_CONTRAT>'||
			'<CGVCN_FECHA_JUSTIFICACION>'||COALESCE(OLD.CGVCN_FECHA_JUSTIFICACION, CURRENT_TIMESTAMP)||'</CGVCN_FECHA_JUSTIFICACION>'||
			'<CGVCN_ESTADO>'||COALESCE(OLD.CGVCN_ESTADO, FALSE)||'</CGVCN_ESTADO>'||
			'<CGVCN_FECHA_INSERT>'||COALESCE(OLD.CGVCN_FECHA_INSERT, CURRENT_TIMESTAMP)||'</CGVCN_FECHA_INSERT>'||
			'<CGVCN_USUARIO_INSERT>'||COALESCE(OLD.CGVCN_USUARIO_INSERT, '')||'</CGVCN_USUARIO_INSERT>'||
			'<CGVCN_FECHA_UPDATE>'||COALESCE(OLD.CGVCN_FECHA_UPDATE, CURRENT_TIMESTAMP)||'</CGVCN_FECHA_UPDATE>'||
			'<CGVCN_USUARIO_UPDATE>'||COALESCE(OLD.CGVCN_USUARIO_UPDATE, '')||'</CGVCN_USUARIO_UPDATE>'||
		'</'||TG_TABLE_NAME||'>';
	ELSIF (TG_OP = 'DELETE') THEN
		SELECT INET_CLIENT_ADDR() INTO TMP_IP;
		SELECT SESSION_USER INTO TMP_SESSION_ID;
	END IF;

	IF (TG_OP = 'INSERT' OR TG_OP = 'UPDATE') THEN
		TMP_DATO_NUEVO = '<'||TG_TABLE_NAME||'>'||
			'<CGVCN_CODIGO>'||COALESCE(NEW.CGVCN_CODIGO, '')||'</CGVCN_CODIGO>'||
			'<CUSU_CODIGO>'||COALESCE(NEW.CUSU_CODIGO, '')||'</CUSU_CODIGO>'||
			'<CSCTP_CODIGO>'||COALESCE(NEW.CSCTP_CODIGO, '')||'</CSCTP_CODIGO>'||
			'<CGTCN_CODIGO>'||COALESCE(NEW.CGTCN_CODIGO, '')||'</CGTCN_CODIGO>'||
			'<CGTSA_CODIGO>'||COALESCE(NEW.CGTSA_CODIGO, '')||'</CGTSA_CODIGO>'||
			'<CGCRG_CODIGO>'||COALESCE(NEW.CGCRG_CODIGO, '')||'</CGCRG_CODIGO>'||
			'<CISLA_CODIGO>'||COALESCE(NEW.CISLA_CODIGO, '')||'</CISLA_CODIGO>'||
			'<CGTPR_CODIGO>'||COALESCE(NEW.CGTPR_CODIGO, '')||'</CGTPR_CODIGO>'||
			'<CGVCN_NUMERO>'||COALESCE(NEW.CGVCN_NUMERO, 0)||'</CGVCN_NUMERO>'||
			'<CGVCN_TITULO>'||COALESCE(NEW.CGVCN_TITULO, '')||'</CGVCN_TITULO>'||
			'<CGVCN_DESCRIPCION>'||COALESCE(NEW.CGVCN_DESCRIPCION, '')||'</CGVCN_DESCRIPCION>'||
			'<CGVCN_SALARIO>'||COALESCE(NEW.CGVCN_SALARIO, 0)||'</CGVCN_SALARIO>'||
			'<CGVCN_DIRECCION>'||COALESCE(NEW.CGVCN_DIRECCION, '')||'</CGVCN_DIRECCION>'||
			'<CGVCN_FECHA_INGRESO>'||COALESCE(NEW.CGVCN_FECHA_INGRESO, CURRENT_TIMESTAMP)||'</CGVCN_FECHA_INGRESO>'||
			'<CGVCN_FECHA_PUBLICACION>'||COALESCE(NEW.CGVCN_FECHA_PUBLICACION, CURRENT_TIMESTAMP)||'</CGVCN_FECHA_PUBLICACION>'||
			'<CGVCN_FECHA_EXPIRACION>'||COALESCE(NEW.CGVCN_FECHA_EXPIRACION, CURRENT_TIMESTAMP)||'</CGVCN_FECHA_EXPIRACION>'||
			'<CGVCN_DURACION_OFERTA>'||COALESCE(NEW.CGVCN_DURACION_OFERTA, 0)||'</CGVCN_DURACION_OFERTA>'||
			'<CGVCN_ESTADO_OFERTA>'||COALESCE(NEW.CGVCN_ESTADO_OFERTA, 0)||'</CGVCN_ESTADO_OFERTA>'||
			'<CGVCN_NUMERO_VACANTES>'||COALESCE(NEW.CGVCN_NUMERO_VACANTES, 0)||'</CGVCN_NUMERO_VACANTES>'||
			'<CGVCN_DURACION>'||COALESCE(NEW.CGVCN_DURACION, 0)||'</CGVCN_DURACION>'||
			'<CGVCN_DURACION_TIEMPO>'||COALESCE(NEW.CGVCN_DURACION_TIEMPO, 0)||'</CGVCN_DURACION_TIEMPO>'||
			'<CGVCN_EXPERIENCIA>'||COALESCE(NEW.CGVCN_EXPERIENCIA, '')||'</CGVCN_EXPERIENCIA>'||
			'<CGVCN_NUMERO_COMUNICADO>'||COALESCE(NEW.CGVCN_NUMERO_COMUNICADO, '')||'</CGVCN_NUMERO_COMUNICADO>'||
			'<CGVCN_OFERTA_APROBADA>'||COALESCE(NEW.CGVCN_OFERTA_APROBADA, 0)||'</CGVCN_OFERTA_APROBADA>'||
			'<CGVCN_EXISTENCIA_MANOBRA>'||COALESCE(NEW.CGVCN_EXISTENCIA_MANOBRA, 0)||'</CGVCN_EXISTENCIA_MANOBRA>'||
			'<CGVCN_NUMERO_MANOBRA>'||COALESCE(NEW.CGVCN_NUMERO_MANOBRA, '')||'</CGVCN_NUMERO_MANOBRA>'||
			'<CGVCN_FECHA_MANOBRA>'||COALESCE(NEW.CGVCN_FECHA_MANOBRA, CURRENT_TIMESTAMP)||'</CGVCN_FECHA_MANOBRA>'||
			'<CGVCN_ANIO>'||COALESCE(NEW.CGVCN_ANIO, 0)||'</CGVCN_ANIO>'||
			'<CGVCN_CUBIERTA>'||COALESCE(NEW.CGVCN_CUBIERTA, FALSE)||'</CGVCN_CUBIERTA>'||
			'<CGVCN_JUSTIFICACION_NO_CONTRAT>'||COALESCE(NEW.CGVCN_JUSTIFICACION_NO_CONTRAT, '')||'</CGVCN_JUSTIFICACION_NO_CONTRAT>'||
			'<CGVCN_FECHA_JUSTIFICACION>'||COALESCE(NEW.CGVCN_FECHA_JUSTIFICACION, CURRENT_TIMESTAMP)||'</CGVCN_FECHA_JUSTIFICACION>'||
			'<CGVCN_ESTADO>'||COALESCE(NEW.CGVCN_ESTADO, FALSE)||'</CGVCN_ESTADO>'||
			'<CGVCN_FECHA_INSERT>'||COALESCE(NEW.CGVCN_FECHA_INSERT, CURRENT_TIMESTAMP)||'</CGVCN_FECHA_INSERT>'||
			'<CGVCN_USUARIO_INSERT>'||COALESCE(NEW.CGVCN_USUARIO_INSERT, '')||'</CGVCN_USUARIO_INSERT>'||
			'<CGVCN_FECHA_UPDATE>'||COALESCE(NEW.CGVCN_FECHA_UPDATE, CURRENT_TIMESTAMP)||'</CGVCN_FECHA_UPDATE>'||
			'<CGVCN_USUARIO_UPDATE>'||COALESCE(NEW.CGVCN_USUARIO_UPDATE, '')||'</CGVCN_USUARIO_UPDATE>'||
		'</'||TG_TABLE_NAME||'>';
	END IF;

	INSERT INTO SII.CGG_SEC_AUDITORIA(
		CSADT_CODIGO,
		CSADT_FECHA,
		CSADT_USUARIO,
		CSADT_IP,
		CSADT_SESION,
		CSADT_TABLA,
		CSADT_OPERACION,
		CSADT_DATO_ANTIGUO,
		CSADT_DATO_NUEVO
	) VALUES (
		('CSADT'||NEXTVAL('scn_cgg_sec_auditoria'))::VARCHAR,
		CURRENT_TIMESTAMP,
		TMP_USUARIO,
		TMP_IP,
		TMP_SESSION_ID,
		TG_TABLE_NAME,
		TG_OP,
		TMP_DATO_ANTIGUO,
		TMP_DATO_NUEVO
	);
	RETURN NULL;
END;
$$
LANGUAGE plpgsql;

/**
* DISPARADOR TRG_KG_CGG_GEM_VACANTE. REGISTRA UNA BITACORA DE LAS ACTIVIDADES REALIZADAS SOBRE LA INFORMACION ALMACENADA EN LA TABLA SII.CGG_GEM_VACANTE
*/
CREATE TRIGGER TRG_AUD_CGG_GEM_VACANTE AFTER INSERT OR UPDATE OR DELETE ON SII.CGG_GEM_VACANTE FOR EACH ROW EXECUTE PROCEDURE SII.TRG_AUD_CGG_GEM_VACANTE();
COMMENT ON TRIGGER TRG_AUD_CGG_GEM_VACANTE ON SII.CGG_GEM_VACANTE IS 'DISPARADOR DE AUDITORIA DE LOS DATOS';
ALTER TABLE SII.CGG_GEM_VACANTE DISABLE TRIGGER TRG_AUD_CGG_GEM_VACANTE;

