/**
* FUNCION SII.F_CGG_RES_INFORME_TESTIGO_TESTIGOS
* SELECCIONA LA INFORMACION DE LA TABLA CGG_RES_INFORME_TESTIGO.
* @param IN_CRINT_CODIGO IDENTIFICATIVO DE INFORME DE TESTIGO
* @param IN_USER_NAME NOMBRE DE USUARIO DEL SERVIDOR DE APLICACIONES
* @param IN_START_INDEX INDICE DE INICIO
* @param IN_LIMIT TOTAL DE REGISTROS QUE SON CONSIDERADOS
* @param IN_SORT_FIELD_NAME NOMBRE DE LA COLUMNA DEL ORDENAMIENTO 
* @param IN_DIRECTION DIRECCION DEL ORDENAMIENTO
* @param IN_FIND_TEXT CRITERIO DE BUSQUEDA
* @return REFCURSOR
*/
CREATE OR REPLACE FUNCTION SII.F_CGG_RES_INFORME_TESTIGO_TESTIGOS(
IN_CRINT_CODIGO  CHARACTER VARYING,
IN_USER_NAME CHARACTER VARYING,
IN_START_INDEX INTEGER, 
IN_LIMIT INTEGER, 
IN_SORT_FIELD_NAME CHARACTER VARYING, 
IN_DIRECTION CHARACTER VARYING,
IN_FIND_TEXT TEXT)
  RETURNS SETOF REFCURSOR AS
$BODY$
DECLARE
	TMP_REF REFCURSOR;
BEGIN
	OPEN TMP_REF FOR EXECUTE 
	'SELECT
		TS.CRTST_CODIGO,
		TS.CRINT_CODIGO, 
		TS.CRPER_CODIGO,
		(SELECT CRPER_NOMBRES||'' ''||CRPER_APELLIDO_PATERNO||'' ''||CRPER_APELLIDO_MATERNO FROM SII.CGG_RES_PERSONA WHERE CRPER_CODIGO = TS.CRPER_CODIGO) TESTIGO,
		TS.CRTST_TESTIMONIO,
		TS.CRTST_OBSERVACION,
		TS.CRTST_ESTADO, 
		TS.CRTST_FECHA_INSERT, 
		TS.CRTST_USUARIO_INSERT, 
		TS.CRTST_FECHA_UPDATE, 
		TS.CRTST_USUARIO_UPDATE
	FROM SII.CGG_RES_TESTIGO TS
	INNER JOIN SII.CGG_RES_INFORME_TESTIGO IT ON IT.CRINT_CODIGO =  TS.CRINT_CODIGO
WHERE TS.CRTST_ESTADO = TRUE AND SII.F_STRING_IN('''||IN_FIND_TEXT||''',
CASE WHEN TS.CRTST_CODIGO IS NULL THEN '''' ELSE TS.CRTST_CODIGO END ||'' ''||
CASE WHEN TS.CRINT_CODIGO IS NULL THEN '''' ELSE TS.CRINT_CODIGO END ||'' ''||
CASE WHEN TS.CRPER_CODIGO IS NULL THEN '''' ELSE TS.CRPER_CODIGO END ||'' ''||
CASE WHEN TS.CRTST_TESTIMONIO IS NULL THEN '''' ELSE TS.CRTST_TESTIMONIO END ||'' ''||
CASE WHEN TS.CRTST_OBSERVACION IS NULL THEN '''' ELSE TS.CRTST_OBSERVACION END ||'' ''||
CASE WHEN TS.CRTST_ESTADO IS NULL THEN FALSE ELSE TS.CRTST_ESTADO END ||'' ''||
CASE WHEN TS.CRTST_FECHA_INSERT IS NULL THEN CURRENT_TIMESTAMP ELSE TS.CRTST_FECHA_INSERT END ||'' ''||
CASE WHEN TS.CRTST_USUARIO_INSERT IS NULL THEN '''' ELSE TS.CRTST_USUARIO_INSERT END ||'' ''||
CASE WHEN TS.CRTST_FECHA_UPDATE IS NULL THEN CURRENT_TIMESTAMP ELSE TS.CRTST_FECHA_UPDATE END ||'' ''||
CASE WHEN TS.CRTST_USUARIO_UPDATE IS NULL THEN '''' ELSE TS.CRTST_USUARIO_UPDATE END ) = 1 AND
IT.CRINT_CODIGO = '''||IN_CRINT_CODIGO||''' 
	ORDER BY '||IN_SORT_FIELD_NAME||' '||IN_DIRECTION||
	' LIMIT '||IN_LIMIT||' OFFSET '||IN_START_INDEX;	
	RETURN NEXT TMP_REF;
END
$BODY$
  LANGUAGE 'PLPGSQL' VOLATILE
  COST 100
  ROWS 1000;