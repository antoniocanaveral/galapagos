/**
* FUNCION SII.F_CONFIRMAR_RESIDENCIA
* CONFIRMA O ANULA UNA RESIDENCIA
* @param IN_CRSEG_CODIGO CODIGO DEL SEGUIMIENTO QUE LLAMA A LA FUNCION.
* @param IN_USER_NAME NOMBRE DEL USUARIO DEL SERVIDOR DE APLICACIONES
* @returns VOID
*/
CREATE OR REPLACE FUNCTION SII.F_CONFIRMAR_RESIDENCIA(
IN IN_CRSEG_CODIGO SII.CGG_RES_SEGUIMIENTO.CRSEG_CODIGO%TYPE, 
IN IN_USER_NAME VARCHAR
)RETURNS VARCHAR AS
$$
DECLARE
OUT_RES VARCHAR;
TMP_CRTRA_CODIGO VARCHAR;
--TIPO DE RESPUESTA DEL SEGUIMIENTO DEL TRAMITE
TMP_CRSEG_TIPO_RESPUESTA INT;
TMP_NUM_RESIDENCIA VARCHAR;
TMP_MSG VARCHAR;
BEGIN
	SELECT TRM.CRTRA_CODIGO, CRSEG_TIPO_RESPUESTA INTO TMP_CRTRA_CODIGO, TMP_CRSEG_TIPO_RESPUESTA
	FROM SII.CGG_RES_TRAMITE TRM
	INNER JOIN SII.CGG_RES_SEGUIMIENTO SGM ON SGM.CRTRA_CODIGO = TRM.CRTRA_CODIGO AND SGM.CRSEG_CODIGO = IN_CRSEG_CODIGO;
	
	SELECT CRPER_NUMERO_RESIDENCIA INTO TMP_NUM_RESIDENCIA
	FROM SII.CGG_RES_PERSONA PRS
	WHERE PRS.CRPER_CODIGO = (SELECT CGG_CRPER_CODIGO FROM SII.CGG_RES_TRAMITE WHERE CRTRA_CODIGO = TMP_CRTRA_CODIGO);
		
	IF (TMP_CRSEG_TIPO_RESPUESTA = 1) THEN
		SELECT SII.F_CGG_RES_RESIDENCIA_GENERAR(IN_USER_NAME, TMP_CRTRA_CODIGO, IN_CRSEG_CODIGO) INTO OUT_RES;
		IF (OUT_RES = 'TRUE') THEN
			OUT_RES = 'La residencia '||TMP_NUM_RESIDENCIA::VARCHAR||' ha sido confirmada.';
		END IF;
	ELSE
		SELECT SII.F_CGG_RES_RESIDENCIA_REVOCAR(IN_USER_NAME, TMP_CRTRA_CODIGO, IN_CRSEG_CODIGO, 1) INTO OUT_RES;
		IF (OUT_RES = 'TRUE') THEN
			OUT_RES = 'La residencia '||TMP_NUM_RESIDENCIA::VARCHAR||' ha sido revocada.';
		END IF;
	END IF;
	
	IF (OUT_RES IS NULL) THEN
		OUT_RES := 'Se han producido problemas al confirmar la residencia.';
	END IF;
	
	RETURN OUT_RES;
END
$$
LANGUAGE 'plpgsql' VOLATILE CALLED ON NULL INPUT;