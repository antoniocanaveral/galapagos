/**
* FUNCION SII.F_CUPO_VEHICULAR_DISPONIBLE
* VERIFICA SI LA PERSONA SOLICITANTE TIENE EL CUPO VEHICULAR DISPONIBLE
* @param IN_CRPER_CODIGO CODIGO DE REGISTRO DE PERSONA
* @param IN_OPERADOR OPERADOR UTILIZADO PARA EVALUAR EL RESULTADO
* @param IN_VALOR_COMPARACION VALOR DE VALIDACION
* @return CHARACTER VARYING
*/
CREATE OR REPLACE FUNCTION SII.F_CUPO_VEHICULAR_DISPONIBLE(
IN IN_CRPER_CODIGO VARCHAR,
IN IN_OPERADOR CHARACTER VARYING,
IN IN_VALOR_COMPARACION CHARACTER VARYING
)RETURNS CHARACTER VARYING AS
$$
DECLARE
	TMP_CUPO BOOLEAN;
	TMP_RESULTADO VARCHAR;
BEGIN	

	SELECT CRPER_CUPO_VEHICULAR INTO TMP_CUPO FROM SII.CGG_RES_PERSONA
	WHERE CRPER_CODIGO = IN_CRPER_CODIGO;
	
	IF (TMP_CUPO IS NULL) THEN
		TMP_CUPO := TRUE;
	END IF;
	
	SELECT SII.F_CGG_REGLA_VALIDACION((CASE WHEN TMP_CUPO THEN 'TRUE' ELSE 'FALSE' END), IN_OPERADOR, IN_VALOR_COMPARACION) INTO TMP_RESULTADO;
	RETURN TMP_RESULTADO;	
END
$$
LANGUAGE 'PLPGSQL' VOLATILE;

/**
* FUNCION SII.F_PROPIETARIO_VEHICULAR
* VERIFICA SI LA PERSONA SOLICITANTE ES PROPIETARIO DEL VEHICULO INDICADO.
* @param IN_CRPER_CODIGO CODIGO DE REGISTRO DE PERSONA
* @param IN_CVVEH_CODIGO CODIGO DE REGISTRO DE VEHICULO
* @param IN_OPERADOR OPERADOR UTILIZADO PARA EVALUAR EL RESULTADO
* @param IN_VALOR_COMPARACION VALOR DE VALIDACION
* @return REFCURSOR
*/
CREATE OR REPLACE FUNCTION SII.F_PROPIETARIO_VEHICULAR(
IN IN_CRPER_CODIGO VARCHAR,
IN IN_CVVEH_CODIGO VARCHAR,
IN IN_OPERADOR CHARACTER VARYING,
IN IN_VALOR_COMPARACION CHARACTER VARYING
)RETURNS CHARACTER VARYING AS
$$
DECLARE
	TMP_CUPO BOOLEAN;
	TMP_RESULTADO VARCHAR;
BEGIN	

	SELECT CVHST_PROPIETARIO INTO TMP_CUPO
	FROM SII.CGG_VEH_HISTORIAL HST 
	INNER JOIN SII.CGG_VEH_VEHICULO VHC ON VHC.CVVEH_CODIGO = HST.CVVEH_CODIGO AND CVVEH_INGRESO AND (NOT CVVEH_SALIO OR CVVEH_SALIO IS NULL)
	WHERE CVHST_PROPIETARIO AND
		HST.CRPER_CODIGO = IN_CRPER_CODIGO AND
		HST.CVVEH_CODIGO = IN_CVVEH_CODIGO;
	
	IF (TMP_CUPO IS NULL) THEN
		TMP_CUPO := FALSE;
	END IF;
	
	SELECT SII.F_CGG_REGLA_VALIDACION((CASE WHEN TMP_CUPO THEN 'TRUE' ELSE 'FALSE' END), IN_OPERADOR, IN_VALOR_COMPARACION) INTO TMP_RESULTADO;
	RETURN TMP_RESULTADO;	
END
$$
LANGUAGE 'PLPGSQL' VOLATILE;