/**
* FUNCION SII.TRG_KG_CGG_RES_PERSONA. REGISTRA LA BITACORA DE LAS ACTIVIDADES REALIZADAS SOBRE LA INFORMACION ALMACENADA EN LA TABLA SII.CGG_RES_PERSONA
*/
CREATE OR REPLACE FUNCTION SII.TRG_AUD_CGG_RES_PERSONA() RETURNS TRIGGER AS
$$
DECLARE
TMP_CUSU_CODIGO VARCHAR;
TMP_IP VARCHAR;
TMP_SESSION_ID VARCHAR;
TMP_DATO_NUEVO VARCHAR;
TMP_DATO_ANTIGUO VARCHAR;
TMP_USUARIO VARCHAR;
TMP_CODIGO VARCHAR;
BEGIN
	TMP_DATO_ANTIGUO = '';
	TMP_DATO_NUEVO = '';
	IF (TG_OP = 'INSERT') THEN
		TMP_USUARIO = NEW.CRPER_USUARIO_INSERT;
		SELECT CUSU_CODIGO INTO TMP_CUSU_CODIGO FROM SII.CGG_USUARIO WHERE CUSU_NOMBRE_USUARIO = NEW.CRPER_USUARIO_INSERT;
		SELECT CSSSN_IP, CSSSN_ID INTO TMP_IP, TMP_SESSION_ID FROM SII.CGG_SEC_SESION WHERE CUSU_CODIGO = TMP_CUSU_CODIGO AND CSSSN_ACTIVO = TRUE;
	ELSIF (TG_OP = 'UPDATE') THEN
		TMP_USUARIO = NEW.CRPER_USUARIO_UPDATE;
		SELECT CUSU_CODIGO INTO TMP_CUSU_CODIGO FROM SII.CGG_USUARIO WHERE CUSU_NOMBRE_USUARIO = NEW.CRPER_USUARIO_UPDATE;
		SELECT CSSSN_IP, CSSSN_ID INTO TMP_IP, TMP_SESSION_ID FROM SII.CGG_SEC_SESION WHERE CUSU_CODIGO = TMP_CUSU_CODIGO AND CSSSN_ACTIVO = TRUE;
		TMP_DATO_ANTIGUO = '<'||TG_TABLE_NAME||'>'||
			'<CRPER_CODIGO>'||COALESCE(OLD.CRPER_CODIGO, '')||'</CRPER_CODIGO>'||
			'<CRECV_CODIGO>'||COALESCE(OLD.CRECV_CODIGO, '')||'</CRECV_CODIGO>'||
			'<CRDID_CODIGO>'||COALESCE(OLD.CRDID_CODIGO, '')||'</CRDID_CODIGO>'||
			'<CRTSG_CODIGO>'||COALESCE(OLD.CRTSG_CODIGO, '')||'</CRTSG_CODIGO>'||
			'<CGNCN_CODIGO>'||COALESCE(OLD.CGNCN_CODIGO, '')||'</CGNCN_CODIGO>'||
			'<CPRR_CODIGO>'||COALESCE(OLD.CPRR_CODIGO, '')||'</CPRR_CODIGO>'||
			'<CCTN_CODIGO>'||COALESCE(OLD.CCTN_CODIGO, '')||'</CCTN_CODIGO>'||
			'<CGG_CCTN_CODIGO>'||COALESCE(OLD.CGG_CCTN_CODIGO, '')||'</CGG_CCTN_CODIGO>'||
			'<CPAIS_CODIGO>'||COALESCE(OLD.CPAIS_CODIGO, '')||'</CPAIS_CODIGO>'||
			'<CGG_CPAIS_CODIGO>'||COALESCE(OLD.CGG_CPAIS_CODIGO, '')||'</CGG_CPAIS_CODIGO>'||
			'<CRPER_NOMBRES>'||COALESCE(OLD.CRPER_NOMBRES, '')||'</CRPER_NOMBRES>'||
			'<CRPER_APELLIDO_PATERNO>'||COALESCE(OLD.CRPER_APELLIDO_PATERNO, '')||'</CRPER_APELLIDO_PATERNO>'||
			'<CRPER_APELLIDO_MATERNO>'||COALESCE(OLD.CRPER_APELLIDO_MATERNO, '')||'</CRPER_APELLIDO_MATERNO>'||
			'<CRPER_NUM_DOC_IDENTIFIC>'||COALESCE(OLD.CRPER_NUM_DOC_IDENTIFIC, '')||'</CRPER_NUM_DOC_IDENTIFIC>'||
			'<CRPER_FECHA_NACIMIENTO>'||COALESCE(OLD.CRPER_FECHA_NACIMIENTO, CURRENT_TIMESTAMP)||'</CRPER_FECHA_NACIMIENTO>'||
			'<CRPER_LUGAR_NACIMIENTO>'||COALESCE(OLD.CRPER_LUGAR_NACIMIENTO, '')||'</CRPER_LUGAR_NACIMIENTO>'||
			'<CRPER_GENERO>'||COALESCE(OLD.CRPER_GENERO, 0)||'</CRPER_GENERO>'||
			'<CRPER_OBSERVACIONES>'||COALESCE(OLD.CRPER_OBSERVACIONES, '')||'</CRPER_OBSERVACIONES>'||
			'<CRPER_NUMERO_RESIDENCIA>'||COALESCE(OLD.CRPER_NUMERO_RESIDENCIA, '')||'</CRPER_NUMERO_RESIDENCIA>'||
			'<CRPER_FOTO>'||COALESCE(encode(OLD.CRPER_FOTO, 'base64'), '')||'</CRPER_FOTO>'||
			'<CRPER_FOTO_CURRICULUM>'||COALESCE(encode(OLD.CRPER_FOTO_CURRICULUM, 'base64'), '')||'</CRPER_FOTO_CURRICULUM>'||
			'<CRPER_HUELLA_DACTILAR>'||COALESCE(OLD.CRPER_HUELLA_DACTILAR, '')||'</CRPER_HUELLA_DACTILAR>'||
			'<CRPER_HUELLA_IMAGEN>'||COALESCE(encode(OLD.CRPER_HUELLA_IMAGEN, 'base64'), '')||'</CRPER_HUELLA_IMAGEN>'||
			'<CRPER_HUELLA_CADENA>'||COALESCE(OLD.CRPER_HUELLA_CADENA, '')||'</CRPER_HUELLA_CADENA>'||
			'<CRPER_FIRMA>'||COALESCE(encode(OLD.CRPER_FIRMA, 'base64'), '')||'</CRPER_FIRMA>'||
			'<CRPER_AUTORIZADO>'||COALESCE(OLD.CRPER_AUTORIZADO, FALSE)||'</CRPER_AUTORIZADO>'||
			'<CRPER_NUMERO_EXPEDIENTE>'||COALESCE(OLD.CRPER_NUMERO_EXPEDIENTE, '')||'</CRPER_NUMERO_EXPEDIENTE>'||
			'<CRPER_FECHA_ARCHIVO>'||COALESCE(OLD.CRPER_FECHA_ARCHIVO, CURRENT_TIMESTAMP)||'</CRPER_FECHA_ARCHIVO>'||
			'<CRPER_EMPLEADO>'||COALESCE(OLD.CRPER_EMPLEADO, FALSE)||'</CRPER_EMPLEADO>'||
			'<CRPER_FECHA_ULTIMO_EMPLEO>'||COALESCE(OLD.CRPER_FECHA_ULTIMO_EMPLEO, CURRENT_TIMESTAMP)||'</CRPER_FECHA_ULTIMO_EMPLEO>'||
			'<CRPER_ASPIRACION_SALARIAL>'||COALESCE(OLD.CRPER_ASPIRACION_SALARIAL, 0)||'</CRPER_ASPIRACION_SALARIAL>'||
			'<CRPER_CUPO_VEHICULAR>'||COALESCE(OLD.CRPER_CUPO_VEHICULAR, FALSE)||'</CRPER_CUPO_VEHICULAR>'||
			'<CRPER_TIPO_PERSONA>'||COALESCE(OLD.CRPER_TIPO_PERSONA, 0)||'</CRPER_TIPO_PERSONA>'||
			'<CRPER_ESTADO_INTERFECTO>'||COALESCE(OLD.CRPER_ESTADO_INTERFECTO, FALSE)||'</CRPER_ESTADO_INTERFECTO>'||
			'<CRPER_FECHA_DEFUNCION>'||COALESCE(OLD.CRPER_FECHA_DEFUNCION, CURRENT_TIMESTAMP)||'</CRPER_FECHA_DEFUNCION>'||
			'<CRPER_NUMERO_ACTA>'||COALESCE(OLD.CRPER_NUMERO_ACTA, '')||'</CRPER_NUMERO_ACTA>'||
			'<CRPER_ADJUNTO_ACTA>'||COALESCE(encode(OLD.CRPER_ADJUNTO_ACTA, 'base64'), '')||'</CRPER_ADJUNTO_ACTA>'||
			'<CRPER_NOMBRE_ADJUNTO_ACTA>'||COALESCE(OLD.CRPER_NOMBRE_ADJUNTO_ACTA, '')||'</CRPER_NOMBRE_ADJUNTO_ACTA>'||
			'<CRPER_TIPO>'||COALESCE(OLD.CRPER_TIPO, 0)||'</CRPER_TIPO>'||
			'<CRPER_ATENCION_CLIENTE>'||COALESCE(OLD.CRPER_ATENCION_CLIENTE, FALSE)||'</CRPER_ATENCION_CLIENTE>'||
			'<CRPER_ESTADO>'||COALESCE(OLD.CRPER_ESTADO, FALSE)||'</CRPER_ESTADO>'||
			'<CRPER_FECHA_INSERT>'||COALESCE(OLD.CRPER_FECHA_INSERT, CURRENT_TIMESTAMP)||'</CRPER_FECHA_INSERT>'||
			'<CRPER_USUARIO_INSERT>'||COALESCE(OLD.CRPER_USUARIO_INSERT, '')||'</CRPER_USUARIO_INSERT>'||
			'<CRPER_FECHA_UPDATE>'||COALESCE(OLD.CRPER_FECHA_UPDATE, CURRENT_TIMESTAMP)||'</CRPER_FECHA_UPDATE>'||
			'<CRPER_USUARIO_UPDATE>'||COALESCE(OLD.CRPER_USUARIO_UPDATE, '')||'</CRPER_USUARIO_UPDATE>'||
		'</'||TG_TABLE_NAME||'>';
	ELSIF (TG_OP = 'DELETE') THEN
		SELECT INET_CLIENT_ADDR() INTO TMP_IP;
		SELECT SESSION_USER INTO TMP_SESSION_ID;
	END IF;

	IF (TG_OP = 'INSERT' OR TG_OP = 'UPDATE') THEN
		TMP_DATO_NUEVO = '<'||TG_TABLE_NAME||'>'||
			'<CRPER_CODIGO>'||COALESCE(NEW.CRPER_CODIGO, '')||'</CRPER_CODIGO>'||
			'<CRECV_CODIGO>'||COALESCE(NEW.CRECV_CODIGO, '')||'</CRECV_CODIGO>'||
			'<CRDID_CODIGO>'||COALESCE(NEW.CRDID_CODIGO, '')||'</CRDID_CODIGO>'||
			'<CRTSG_CODIGO>'||COALESCE(NEW.CRTSG_CODIGO, '')||'</CRTSG_CODIGO>'||
			'<CGNCN_CODIGO>'||COALESCE(NEW.CGNCN_CODIGO, '')||'</CGNCN_CODIGO>'||
			'<CPRR_CODIGO>'||COALESCE(NEW.CPRR_CODIGO, '')||'</CPRR_CODIGO>'||
			'<CCTN_CODIGO>'||COALESCE(NEW.CCTN_CODIGO, '')||'</CCTN_CODIGO>'||
			'<CGG_CCTN_CODIGO>'||COALESCE(NEW.CGG_CCTN_CODIGO, '')||'</CGG_CCTN_CODIGO>'||
			'<CPAIS_CODIGO>'||COALESCE(NEW.CPAIS_CODIGO, '')||'</CPAIS_CODIGO>'||
			'<CGG_CPAIS_CODIGO>'||COALESCE(NEW.CGG_CPAIS_CODIGO, '')||'</CGG_CPAIS_CODIGO>'||
			'<CRPER_NOMBRES>'||COALESCE(NEW.CRPER_NOMBRES, '')||'</CRPER_NOMBRES>'||
			'<CRPER_APELLIDO_PATERNO>'||COALESCE(NEW.CRPER_APELLIDO_PATERNO, '')||'</CRPER_APELLIDO_PATERNO>'||
			'<CRPER_APELLIDO_MATERNO>'||COALESCE(NEW.CRPER_APELLIDO_MATERNO, '')||'</CRPER_APELLIDO_MATERNO>'||
			'<CRPER_NUM_DOC_IDENTIFIC>'||COALESCE(NEW.CRPER_NUM_DOC_IDENTIFIC, '')||'</CRPER_NUM_DOC_IDENTIFIC>'||
			'<CRPER_FECHA_NACIMIENTO>'||COALESCE(NEW.CRPER_FECHA_NACIMIENTO, CURRENT_TIMESTAMP)||'</CRPER_FECHA_NACIMIENTO>'||
			'<CRPER_LUGAR_NACIMIENTO>'||COALESCE(NEW.CRPER_LUGAR_NACIMIENTO, '')||'</CRPER_LUGAR_NACIMIENTO>'||
			'<CRPER_GENERO>'||COALESCE(NEW.CRPER_GENERO, 0)||'</CRPER_GENERO>'||
			'<CRPER_OBSERVACIONES>'||COALESCE(NEW.CRPER_OBSERVACIONES, '')||'</CRPER_OBSERVACIONES>'||
			'<CRPER_NUMERO_RESIDENCIA>'||COALESCE(NEW.CRPER_NUMERO_RESIDENCIA, '')||'</CRPER_NUMERO_RESIDENCIA>'||
			'<CRPER_FOTO>'||COALESCE(encode(NEW.CRPER_FOTO, 'base64'), '')||'</CRPER_FOTO>'||
			'<CRPER_FOTO_CURRICULUM>'||COALESCE(encode(NEW.CRPER_FOTO_CURRICULUM, 'base64'), '')||'</CRPER_FOTO_CURRICULUM>'||
			'<CRPER_HUELLA_DACTILAR>'||COALESCE(NEW.CRPER_HUELLA_DACTILAR, '')||'</CRPER_HUELLA_DACTILAR>'||
			'<CRPER_HUELLA_IMAGEN>'||COALESCE(encode(NEW.CRPER_HUELLA_IMAGEN, 'base64'), '')||'</CRPER_HUELLA_IMAGEN>'||
			'<CRPER_HUELLA_CADENA>'||COALESCE(NEW.CRPER_HUELLA_CADENA, '')||'</CRPER_HUELLA_CADENA>'||
			'<CRPER_FIRMA>'||COALESCE(encode(NEW.CRPER_FIRMA, 'base64'), '')||'</CRPER_FIRMA>'||
			'<CRPER_AUTORIZADO>'||COALESCE(NEW.CRPER_AUTORIZADO, FALSE)||'</CRPER_AUTORIZADO>'||
			'<CRPER_NUMERO_EXPEDIENTE>'||COALESCE(NEW.CRPER_NUMERO_EXPEDIENTE, '')||'</CRPER_NUMERO_EXPEDIENTE>'||
			'<CRPER_FECHA_ARCHIVO>'||COALESCE(NEW.CRPER_FECHA_ARCHIVO, CURRENT_TIMESTAMP)||'</CRPER_FECHA_ARCHIVO>'||
			'<CRPER_EMPLEADO>'||COALESCE(NEW.CRPER_EMPLEADO, FALSE)||'</CRPER_EMPLEADO>'||
			'<CRPER_FECHA_ULTIMO_EMPLEO>'||COALESCE(NEW.CRPER_FECHA_ULTIMO_EMPLEO, CURRENT_TIMESTAMP)||'</CRPER_FECHA_ULTIMO_EMPLEO>'||
			'<CRPER_ASPIRACION_SALARIAL>'||COALESCE(NEW.CRPER_ASPIRACION_SALARIAL, 0)||'</CRPER_ASPIRACION_SALARIAL>'||
			'<CRPER_CUPO_VEHICULAR>'||COALESCE(NEW.CRPER_CUPO_VEHICULAR, FALSE)||'</CRPER_CUPO_VEHICULAR>'||
			'<CRPER_TIPO_PERSONA>'||COALESCE(NEW.CRPER_TIPO_PERSONA, 0)||'</CRPER_TIPO_PERSONA>'||
			'<CRPER_ESTADO_INTERFECTO>'||COALESCE(NEW.CRPER_ESTADO_INTERFECTO, FALSE)||'</CRPER_ESTADO_INTERFECTO>'||
			'<CRPER_FECHA_DEFUNCION>'||COALESCE(NEW.CRPER_FECHA_DEFUNCION, CURRENT_TIMESTAMP)||'</CRPER_FECHA_DEFUNCION>'||
			'<CRPER_NUMERO_ACTA>'||COALESCE(NEW.CRPER_NUMERO_ACTA, '')||'</CRPER_NUMERO_ACTA>'||
			'<CRPER_ADJUNTO_ACTA>'||COALESCE(encode(NEW.CRPER_ADJUNTO_ACTA, 'base64'), '')||'</CRPER_ADJUNTO_ACTA>'||
			'<CRPER_NOMBRE_ADJUNTO_ACTA>'||COALESCE(NEW.CRPER_NOMBRE_ADJUNTO_ACTA, '')||'</CRPER_NOMBRE_ADJUNTO_ACTA>'||
			'<CRPER_TIPO>'||COALESCE(NEW.CRPER_TIPO, 0)||'</CRPER_TIPO>'||
			'<CRPER_ATENCION_CLIENTE>'||COALESCE(NEW.CRPER_ATENCION_CLIENTE, FALSE)||'</CRPER_ATENCION_CLIENTE>'||
			'<CRPER_ESTADO>'||COALESCE(NEW.CRPER_ESTADO, FALSE)||'</CRPER_ESTADO>'||
			'<CRPER_FECHA_INSERT>'||COALESCE(NEW.CRPER_FECHA_INSERT, CURRENT_TIMESTAMP)||'</CRPER_FECHA_INSERT>'||
			'<CRPER_USUARIO_INSERT>'||COALESCE(NEW.CRPER_USUARIO_INSERT, '')||'</CRPER_USUARIO_INSERT>'||
			'<CRPER_FECHA_UPDATE>'||COALESCE(NEW.CRPER_FECHA_UPDATE, CURRENT_TIMESTAMP)||'</CRPER_FECHA_UPDATE>'||
			'<CRPER_USUARIO_UPDATE>'||COALESCE(NEW.CRPER_USUARIO_UPDATE, '')||'</CRPER_USUARIO_UPDATE>'||
		'</'||TG_TABLE_NAME||'>';
	END IF;

	INSERT INTO SII.CGG_SEC_AUDITORIA(
		CSADT_CODIGO,
		CSADT_FECHA,
		CSADT_USUARIO,
		CSADT_IP,
		CSADT_SESION,
		CSADT_TABLA,
		CSADT_OPERACION,
		CSADT_DATO_ANTIGUO,
		CSADT_DATO_NUEVO
	) VALUES (
		('CSADT'||NEXTVAL('scn_cgg_sec_auditoria'))::VARCHAR,
		CURRENT_TIMESTAMP,
		TMP_USUARIO,
		TMP_IP,
		TMP_SESSION_ID,
		TG_TABLE_NAME,
		TG_OP,
		TMP_DATO_ANTIGUO,
		TMP_DATO_NUEVO
	);
	RETURN NULL;
END;
$$
LANGUAGE plpgsql;

/**
* DISPARADOR TRG_KG_CGG_RES_PERSONA. REGISTRA UNA BITACORA DE LAS ACTIVIDADES REALIZADAS SOBRE LA INFORMACION ALMACENADA EN LA TABLA SII.CGG_RES_PERSONA
*/
CREATE TRIGGER TRG_AUD_CGG_RES_PERSONA AFTER INSERT OR UPDATE OR DELETE ON SII.CGG_RES_PERSONA FOR EACH ROW EXECUTE PROCEDURE SII.TRG_AUD_CGG_RES_PERSONA();
COMMENT ON TRIGGER TRG_AUD_CGG_RES_PERSONA ON SII.CGG_RES_PERSONA IS 'DISPARADOR DE AUDITORIA DE LOS DATOS';
ALTER TABLE SII.CGG_RES_PERSONA DISABLE TRIGGER TRG_AUD_CGG_RES_PERSONA;

